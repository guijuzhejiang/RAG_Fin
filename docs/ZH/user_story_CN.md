# RAG系统用户故事

## 用户故事 1：创建知识库

**作为** 一名用户

**我希望** 能够创建一个新的、命名的知识库

**以便于** 我将不同的主题或项目的文档分开管理和使用

### 验收标准:

- API应接收 `user_id` 和 `kb_name` (知识库名称) 参数。
- 系统应在数据库中为该用户创建一个新的知识库记录。
- API应返回一个唯一的 `kb_id`。
- 不允许创建同名的知识库（对于同一用户）。

## 用户故事 2：上传文件到知识库

**作为** 一名用户

**我希望** 能够向一个已存在的知识库上传文件（如PDF、TXT、MD等）

**以便于** 系统可以学习这些文件中的内容

### 验收标准:

- API应接收 `user_id`, `kb_id` 和 `file` (文件对象) 参数。
- 系统应验证 `kb_id` 存在且属于该 `user_id`。
- 系统应将文件保存到持久化存储（如S3、服务器磁盘等）。
- 系统应在数据库中创建一条文档记录，并关联到知识库，并返回一个唯一的 `doc_id`。
- 系统应支持常见的文件格式，并拒绝不支持的格式。

## 用户故事 3：解析文件并生成向量

**作为** 一名用户

**我希望** 系统能异步解析我上传的文件，将其分块并生成向量嵌入，然后存储到向量数据库中

**以便于** 后续进行语义搜索

### 验收标准:

- API应接收 `user_id`, `kb_id`, `doc_id` 参数来触发处理任务。
- 系统应验证 `kb_id` 和 `doc_id` 存在且属于该 `user_id`。
- 系统应读取已上传的文件内容。
- 系统应将文本进行分块（Chunking）。
- 系统应调用嵌入模型（如OpenAI text-embedding-ada-002）为每个文本块生成向量。
- 系统应将向量、文本块、元数据（包括 `user_id`, `kb_id`, `doc_id`）保存到Supabase的PgVector表中。
- API应返回任务状态（成功或失败）。

## 用户故事 4：搜索知识库

**作为** 一名用户

**我希望** 能够针对某个知识库提出问题并进行语义搜索

**以便于** 找到最相关的参考信息

### 验收标准:

- API应接收 `user_id`, `kb_id` 和 `query` (用户问题) 参数。
- 系统应验证 `kb_id` 存在且属于该 `user_id`。
- 系统应调用嵌入模型将 `query` 转换为向量。
- 系统应在Supabase中对该知识库的向量集合执行相似度搜索（例如使用余弦相似度）。
- API应返回一个最相关的文本块列表（包括文本内容和来源文档信息）。

## 用户故事 5：基于知识库进行问答

**作为** 一名用户

**我希望** 系统能基于搜索到的相关信息，生成一个连贯且准确的答案来回答我的问题

**以便于** 我直接获得所需信息，而无需自己阅读所有参考文档

### 验收标准:

- API应接收 `user_id`, `kb_id`, `query` 和（可选的）`chat_history` 参数。
- 系统应首先执行搜索知识库的步骤（故事4），获取相关上下文 `context`。
- 系统应构建一个Prompt，将 `context`, `query` 和 `chat_history` 组合成一个指令，发送给大语言模型（如GPT-4）。
- 系统应返回LLM生成的答案，并可选择在答案后附上引用的文档片段来源。
